<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreshChain â€¢ Traceability Dashboard</title>

  <!-- Ethers v5 -->
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // Fallback if unpkg blocked
    if (typeof ethers === "undefined") {
      var s=document.createElement("script");
      s.src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";
      document.head.appendChild(s);
    }
  </script>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1729;
      --card:#121c33;
      --stroke:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.70);
      --muted2:rgba(232,238,252,.55);
      --good:#2bd576;
      --warn:#ffb020;
      --bad:#ff4d6d;
      --brand:#6aa7ff;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(106,167,255,.35), transparent 60%),
                  radial-gradient(900px 500px at 100% 10%, rgba(43,213,118,.25), transparent 55%),
                  radial-gradient(800px 500px at 30% 120%, rgba(255,176,32,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    .app{min-height:100vh; display:grid; grid-template-rows:auto 1fr;}
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,23,.92), rgba(11,15,23,.72));
      border-bottom:1px solid var(--stroke);
    }
    .header-inner{
      max-width:1200px; margin:0 auto;
      padding:14px 18px;
      display:flex; align-items:center; gap:12px;
    }
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;}
    .logo-badge{
      width:34px; height:34px; border-radius:11px;
      background: linear-gradient(135deg, rgba(106,167,255,1), rgba(43,213,118,1));
      box-shadow: 0 14px 34px rgba(106,167,255,.15);
    }
    .header-spacer{flex:1}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:650;
      font-size:13px;
      transition: transform .06s ease, background .15s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, rgba(106,167,255,.25), rgba(106,167,255,.08)); border-color: rgba(106,167,255,.35);}
    .btn.good{background: linear-gradient(135deg, rgba(43,213,118,.22), rgba(43,213,118,.07)); border-color: rgba(43,213,118,.35);}
    .btn.warn{background: linear-gradient(135deg, rgba(255,176,32,.20), rgba(255,176,32,.06)); border-color: rgba(255,176,32,.35);}
    .btn.bad{background: linear-gradient(135deg, rgba(255,77,109,.20), rgba(255,77,109,.06)); border-color: rgba(255,77,109,.35);}
    .btn:disabled{opacity:.45; cursor:not-allowed;}
    .layout{
      max-width:1200px; margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
    }
    aside{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      height: calc(100vh - 96px);
      position: sticky;
      top: 76px;
    }
    .aside-top{
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .role-chip{
      display:flex; flex-direction:column; gap:6px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      font-size:12px;
    }
    .chip-row{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .role-dot{width:9px; height:9px; border-radius:99px; background: var(--muted2)}
    .role-dot.admin{background:#caa6ff}
    .role-dot.producer{background:#2bd576}
    .role-dot.transporter{background:#6aa7ff}
    .role-dot.distributor{background:#ffb020}
    .role-dot.retailer{background:#ff6bd6}
    .nav{padding:10px; display:flex; flex-direction:column; gap:6px;}
    .nav .item{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid transparent;
      color:var(--muted);
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
    }
    .nav .item:hover{background:rgba(255,255,255,.05); color:var(--text)}
    .nav .item.active{background: rgba(106,167,255,.10); border-color: rgba(106,167,255,.25); color: var(--text);}
    .nav .item.disabled{opacity:.45; cursor:not-allowed;}
    .tag{font-size:11px; padding:5px 8px; border-radius:999px; border:1px solid var(--stroke); background: rgba(255,255,255,.03); color: var(--muted);}
    main{min-height:70vh}
    .grid{display:grid; gap:18px; grid-template-columns: 1fr;}
    .card{border:1px solid var(--stroke); background: rgba(255,255,255,.03); border-radius: var(--r); box-shadow: var(--shadow); overflow:hidden;}
    .card-head{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,.04), rgba(255,255,255,.02));
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .card-title{font-weight:800; font-size:15px; letter-spacing:.2px}
    .card-sub{color:var(--muted); font-size:12.5px; margin-top:4px}
    .card-body{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .field{flex: 1 1 220px; display:flex; flex-direction:column; gap:7px;}
    label{font-size:12px; color:var(--muted)}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:84px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(232,238,252,.35)}
    .mono{font-family:var(--mono)}
    .small{font-size:12px; color:var(--muted)}
    .kpi{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; margin-top: 8px;}
    .kpi .box{border:1px solid var(--stroke); border-radius: 16px; padding:12px; background: rgba(0,0,0,.18);}
    .kpi .v{font-size:18px; font-weight:850}
    .kpi .l{font-size:12px; color:var(--muted)}
    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      aside{position:relative; top:0; height:auto}
      .kpi{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    .timeline{display:flex; flex-direction:column; gap:10px}
    .t-item{border:1px solid var(--stroke); border-radius:16px; padding:12px; background: rgba(0,0,0,.16); display:flex; gap:12px;}
    .t-ic{width:34px; height:34px; border-radius:12px; display:grid; place-items:center; border:1px solid var(--stroke); background: rgba(255,255,255,.04); flex:0 0 auto;}
    .t-main{flex:1}
    .t-top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .toast-wrap{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:200;}
    .toast{max-width:420px; border:1px solid var(--stroke); border-radius:16px; padding:12px; background: rgba(0,0,0,.60); backdrop-filter: blur(10px); box-shadow: var(--shadow);}
    .toast .t1{font-weight:800}
    .toast .t2{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}
    .hr{height:1px; background:var(--stroke); margin:12px 0}
    .split{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background: rgba(255,255,255,.03); font-size:12px; color: var(--muted);}
    .pillcode{font-family:var(--mono); font-size:12px; color:var(--text)}

    /* modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; place-items:center; z-index:300;}
    .modal{width:min(520px, calc(100vw - 28px)); border-radius:22px; border:1px solid var(--stroke); background: rgba(18,28,51,.85); backdrop-filter: blur(12px); box-shadow: var(--shadow); overflow:hidden;}
    .modal-head{padding:16px; border-bottom:1px solid var(--stroke); display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .modal-title{font-weight:900}
    .modal-body{padding:16px}
  
/* ==== Layout tweaks for Assigned Batches sections (more breathing room) ==== */
.section{ margin-top: 18px; }
.section-head{ align-items: flex-start; gap: 14px; }
.section-title{ margin-bottom: 2px; }
.section .muted.small{ line-height: 1.35; }
.section .btn{ padding: 10px 14px; }

.list{ margin-top: 14px; }
.list .item,
.list .timeline-item{ margin-bottom: 12px; }

.timeline-item{
  padding: 14px 14px;
}
.timeline-item .right{
  white-space: nowrap;
}
.timeline-item .sub{
  margin-top: 6px;
  line-height: 1.35;
}

.divider{ margin: 18px 0; }

/* Distributor/Retailer actions spacing */
#page-distributor .grid-2,
#page-retailer .grid-2{
  margin-top: 16px;
  gap: 14px;
}
#page-distributor .grid-2 .field,
#page-retailer .grid-2 .field{
  margin-bottom: 10px;
}

</style>

  <!-- QR libs -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <div class="app">
    <header>
      <div class="header-inner">
        <div class="logo">
          <div class="logo-badge"></div>
          <div>
            <div>FreshChain</div>
            <div class="small" style="margin-top:2px;">Traceability Dashboard â€¢ Wallet + Role Based UI</div>
          </div>
        </div>

        <div class="header-spacer"></div>

        <div class="pill mono" id="netPill">Network: <span id="netName">â€”</span></div>
        <div class="pill mono" id="addrPill" style="display:none;">Addr: <span id="addrShort">â€”</span></div>
        <button class="btn primary" id="btnConnect">ğŸ”Œ Connect Wallet</button>
        <button class="btn" id="btnLock" style="display:none;">ğŸ”’ Admin PIN</button>
        <button class="btn" id="btnLogout" style="display:none;">ğŸšª Logout</button>
      </div>
    </header>

    <div class="layout">
      <aside>
        <div class="aside-top">
          <div class="role-chip">
            <div class="chip-row">
              <div class="small">Contract</div>
              <span class="badge"><span class="pillcode mono" id="contractShort">â€”</span></span>
            </div>
            <div class="chip-row">
              <div class="small">Role</div>
              <div class="badge"><span class="role-dot" id="roleDot"></span><span id="roleLabel">Public</span></div>
            </div>
            <div class="chip-row">
              <div class="small">PIN</div>
              <div class="badge" id="pinStatus">ğŸ”“ Not set</div>
            </div>
          </div>
        </div>

        <div class="nav" id="nav">
          <div class="item active" data-page="home"><span>ğŸ  Home</span><span class="tag">Public</span></div>
          <div class="item" data-page="market"><span>ğŸ›ï¸ SatÄ±ÅŸta Olan ÃœrÃ¼nler</span><span class="tag">Public</span></div>
          <div class="item" data-page="query"><span>ğŸ” Sorgula</span><span class="tag">Public</span></div>
          <div class="item" data-page="producer" data-need="producer"><span>ğŸ§‘â€ğŸŒ¾ Producer</span><span class="tag">Create</span></div>
          <div class="item" data-page="transporter" data-need="transporter"><span>ğŸšš Transporter</span><span class="tag">Move</span></div>
          <div class="item" data-page="distributor" data-need="distributor"><span>ğŸ¬ Distributor</span><span class="tag">Forward</span></div>
          <div class="item" data-page="retailer" data-need="retailer"><span>ğŸ›’ Retailer</span><span class="tag">Finalize</span></div>
          <div class="item" data-page="admin" data-need="admin"><span>ğŸ‘‘ Admin</span><span class="tag">Roles</span></div>
          <div class="hr"></div>
          <div class="item" data-page="settings"><span>âš™ï¸ Settings</span><span class="tag">Contract</span></div>
        </div>
      </aside>

      <main>
        <div class="card" id="qrTopBar" style="position:sticky; top:10px; z-index:20; margin-bottom:14px;">
          <div class="card-head" style="padding:12px 14px;">
            <div>
              <div class="card-title" style="font-size:14px;">ğŸ“· QR Okut (Public)</div>
              <div class="card-sub" style="font-size:12px;">QR iÃ§inden batchId alÄ±nÄ±r ve otomatik sorgulanÄ±r.</div>
            </div>
            <div class="split">
              <button class="btn" id="btnStartQR">â–¶ï¸ Start</button>
              <button class="btn bad" id="btnStopQR" disabled>â¹ Stop</button>
            </div>
          </div>
          <div class="card-body" style="padding:12px 14px;">
            <div class="row" style="align-items:flex-end;">
              <div class="field" style="max-width:220px;">
                <label>Son Okunan</label>
                <input id="qrLast" class="mono" placeholder="â€”" readonly />
              </div>
              <div class="field" style="flex:1;">
                <label>Veya Batch ID gir</label>
                <input id="qrManual" class="mono" placeholder="Ã–rn: 17" />
              </div>
              <div class="field" style="flex:0 0 auto;">
                <button class="btn good" id="btnQRGo">ğŸ” Getir</button>
              </div>
            </div>
            <div id="qrReaderWrap" style="display:none; margin-top:10px;">
              <div id="qrReader" style="width:320px; max-width:100%;"></div>
              <div class="small muted" style="margin-top:8px;">Kamera izni ister. Telefonla daha rahat.</div>
            </div>
          </div>
        </div>

        <div class="grid">

          <!-- HOME -->
          <section class="card page" id="page-home">
            <div class="card-head">
              <div>
                <div class="card-title">Home</div>
                <div class="card-sub">SatÄ±ÅŸtaki Ã¼rÃ¼nleri gÃ¶r veya Batch ID/QR ile sorgulama yap.</div>
              </div>
              <div class="split">
                <button class="btn" onclick="gotoPage('market')">ğŸ›ï¸ SatÄ±ÅŸta Olan ÃœrÃ¼nler</button>
                <button class="btn good" onclick="gotoPage('query')">ğŸ” Sorgula</button>
              </div>
            </div>
            <div class="card-body">
              <div class="kpi">
                <div class="box"><div class="v" id="homeKpiBatches">â€”</div><div class="l">Toplam Batch</div></div>
                <div class="box"><div class="v" id="homeKpiOnSale">â€”</div><div class="l">SatÄ±ÅŸta (PASS)</div></div>
                <div class="box"><div class="v" id="homeKpiLastBlock">â€”</div><div class="l">Son Block</div></div>
                <div class="box"><div class="v" id="homeKpiNet">â€”</div><div class="l">Network</div></div>
              </div>

              <div class="hr"></div>
              <div class="small muted" style="line-height:1.5">
                ğŸ“· QR okutma: TarayÄ±cÄ±da kamera Ã§alÄ±ÅŸmasÄ± iÃ§in sayfayÄ± <span class="mono">https://</span> Ã¼zerinden (veya <span class="mono">http://localhost</span>) aÃ§malÄ±sÄ±n.
                <br/>EÄŸer dosyayÄ± <span class="mono">file://</span> olarak aÃ§arsan kamera izin vermez ve QR Ã§alÄ±ÅŸmaz.
              </div>
            </div>
          </section>
          <!-- QUERY -->
<section class="card page" id="page-query" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Sorgula</div>
                <div class="card-sub">Batch ID (QR) ile Ã¼rÃ¼nÃ¼n tÃ¼m geÃ§miÅŸini gÃ¶r.</div>
              </div>
              <div class="split">
                <button class="btn" id="btnRefreshFeed">ğŸ”„ Refresh Feed</button>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="field" style="max-width:220px;">
                  <label>Batch ID</label>
                  <input id="qBatchId" placeholder="Ã–rn: 17" class="mono" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn good" id="btnQuery">ğŸ” Sorgula</button>
                </div>
              </div>

              <div id="batchResult" style="margin-top:14px; display:none;">
                <div class="hr"></div>
                <div class="split">
                  <div>
                    <div class="card-title" style="font-size:14px;">Batch Summary</div>
                    <div class="small muted" id="batchSummaryLine">â€”</div>
                  </div>
                  <div class="right">
                    <span class="badge">Stage: <span class="pillcode mono" id="stageText">â€”</span></span>
                    <span class="badge">Inspection: <span class="pillcode mono" id="inspText">â€”</span></span>
                  </div>
                </div>

                <div class="kpi" id="kpis">
                  <div class="box"><div class="v" id="kpiKg">â€”</div><div class="l">Quantity (kg)</div></div>
                  <div class="box"><div class="v" id="kpiTemp">â€”</div><div class="l">Temp (min/avg/max)</div></div>
                  <div class="box"><div class="v" id="kpiHum">â€”</div><div class="l">Humidity (min/avg/max)</div></div>
                  <div class="box"><div class="v" id="kpiLogs">â€”</div><div class="l">Logs (T / S)</div></div>
                </div>

                <div class="hr"></div>
                <div class="card-title" style="font-size:14px;">Timeline</div>
                <div class="small muted" style="margin-top:6px;">Ãœretim â†’ Transfer â†’ SensÃ¶r â†’ Final kontrol adÄ±mlarÄ±nÄ± burada gÃ¶rÃ¼rsÃ¼n.</div>
                <div class="timeline" id="timeline" style="margin-top:12px;"></div>
              </div>

              <div class="hr"></div>
              <div class="split">
                <div>
                  <div class="card-title" style="font-size:14px;">Global Operations</div>
                  <div class="card-sub">Kontrattaki event kayÄ±tlarÄ±ndan son iÅŸlemler.</div>
                </div>
                <div class="right">
                  <span class="badge">Range: <span class="pillcode mono" id="feedRange">â€”</span></span>
                </div>
              </div>
              <div class="timeline" id="feed" style="margin-top:12px;"></div>
            </div>
          </section>
          <!-- MARKET -->
          <!-- MARKET -->
          <section class="card page" id="page-market" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">SatÄ±ÅŸta Olan ÃœrÃ¼nler</div>
                <div class="card-sub">Retailer tarafÄ±ndan bitirilmiÅŸ (COMPLETED_PASS) Ã¼rÃ¼nler burada listelenir. Her Ã¼rÃ¼n iÃ§in QR oluÅŸur.</div>
              </div>
              <div class="split">
                <button class="btn" id="btnRefreshMarket">ğŸ”„ Yenile</button>
              </div>
            </div>
            <div class="card-body">
              <div class="row" style="align-items:flex-end;">
                <div class="field" style="max-width:320px;">
                  <label>Filtre (isim iÃ§erir)</label>
                  <input id="marketFilter" placeholder="Ã–rn: Domates" />
                </div>
              </div>
              <div class="hr"></div>
              <div id="marketList" class="timeline"></div>
              <div class="small muted" id="marketEmpty" style="display:none; margin-top:10px;">Åu an satÄ±ÅŸta Ã¼rÃ¼n yok.</div>
            </div>
          </section>


          <!-- PRODUCER -->
          <section class="card page" id="page-producer" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Producer Panel</div>
                <div class="card-sub">Yeni Ã¼rÃ¼n (batch) oluÅŸtur, pickup Ã¶ncesi taÅŸÄ±yÄ±cÄ± deÄŸiÅŸtir.</div>
              </div>
              <div class="right">
                <span class="badge">Role: <span class="pillcode mono">PRODUCER</span></span>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="field">
                  <label>ÃœrÃ¼n adÄ±</label>
                  <input id="pName" placeholder="Elma" />
                </div>
                <div class="field">
                  <label>Kg</label>
                  <input id="pKg" placeholder="120" class="mono" />
                </div>
                <div class="field">
                  <label>Atanan TaÅŸÄ±macÄ± Adresi</label>
                  <input id="pTransporter" placeholder="0x..." class="mono" />
                  <div class="small muted">Bu adresin Transporter rolÃ¼nde olmasÄ± gerekir.</div>
                </div>
              </div>
              <div class="split" style="margin-top:12px;">
                <button class="btn good" id="btnCreateBatch">â• Create Batch (Auto ID)</button>
                <span class="small muted" id="pCreateOut">â€”</span>
              </div>

              <div class="hr"></div>

              <div class="card-title" style="font-size:14px;">Update Assigned Transporter</div>
              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label>Batch ID</label>
                  <input id="pUpBatchId" placeholder="17" class="mono" />
                </div>
                <div class="field">
                  <label>New Transporter</label>
                  <input id="pUpTransporter" placeholder="0x..." class="mono" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn warn" id="btnUpdateTransporter">ğŸ” Update</button>
                </div>
              </div>
            </div>
          </section>

          <!-- TRANSPORTER -->
          <section class="card page" id="page-transporter" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Transporter Panel</div>
                <div class="card-sub">Atanan batchâ€™leri gÃ¶r, pickup, sensÃ¶r logla, distribÃ¼tÃ¶re gÃ¶nder.</div>
              </div>
              <div class="right">
                <span class="badge">Role: <span class="pillcode mono">TRANSPORTER</span></span>
              </div>
            </div>
            <div class="card-body">
              <div class="split">
                <div>
                  <div class="card-title" style="font-size:14px;">My Assigned Batches</div>
                  <div class="small muted">Kontrat: getBatchesAssignedTo(address)</div>
                </div>
                <button class="btn" id="btnLoadAssigned">ğŸ“¥ Load</button>
              </div>
              <div class="timeline" id="assignedList" style="margin-top:12px;"></div>

              <div class="hr"></div>
              <div class="card-title" style="font-size:14px;">Actions</div>
              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label>Batch ID</label>
                  <input id="tBatchId" placeholder="17" class="mono" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn good" id="btnAcceptPickup">âœ… Accept Pickup</button>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label>Temperature (Â°C)</label>
                  <input id="tTemp" placeholder="6" class="mono" />
                </div>
                <div class="field">
                  <label>Humidity (%)</label>
                  <input id="tHum" placeholder="30" class="mono" />
                </div>
                <div class="field">
                  <label>Location</label>
                  <input id="tLoc" placeholder="Istanbul / Depo 3" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn" id="btnAddSensor">ğŸŒ¡ï¸ Add Sensor</button>
                </div>
              </div>

              <div class="row" style="margin-top:10px;">
                <div class="field">
                  <label>Distributor Address</label>
                  <input id="tDistributor" placeholder="0x..." class="mono" />
                  <div class="small muted">Hedef adresin Distributor rolÃ¼nde olmasÄ± gerekir.</div>
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <span class="badge" style="margin-right:10px;">Selected Batch: <span class="pillcode mono" id="tSelectedBadge">â€”</span></span>
                  <button class="btn warn" id="btnToDistributor">ğŸššâ¡ï¸ğŸ¬ Transfer</button>
                </div>
              </div>
            </div>
          </section>

          <!-- DISTRIBUTOR -->
          <section class="card page" id="page-distributor" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Distributor Panel</div>
                <div class="card-sub">Batchâ€™i maÄŸazaya yÃ¶nlendir.</div>
              </div>
              <div class="right">
                <span class="badge">Role: <span class="pillcode mono">DISTRIBUTOR</span></span>
              </div>
            </div>
            <div class="card-body">
              <div class="section" style="margin-top:0;">
                <div class="section-head">
                  <div>
                    <div class="section-title">My Batches (Owned)</div>
                    <div class="muted small">Kontrat: getAllBatchIds() + getBatch() (currentOwner+stage filtre)</div>
                  </div>
                  <button class="btn" id="btnLoadAssignedDistributor">ğŸ“¥ Load</button>
                </div>
                <div class="list" id="dAssignedList"></div>
              </div>
              <div class="divider"></div>

              <div class="row">
                <div class="field">
                  <label>Batch ID</label>
                  <input id="dBatchId" placeholder="17" class="mono" />
                </div>
                <div class="field">
                  <label>Retailer Address</label>
                  <input id="dRetailer" placeholder="0x..." class="mono" />
                  <div class="small muted">Hedef adresin Retailer rolÃ¼nde olmasÄ± gerekir.</div>
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <span class="badge" style="margin-right:10px;">Selected Batch: <span class="pillcode mono" id="dSelectedBadge">â€”</span></span>
                  <button class="btn warn" id="btnToRetailer">ğŸ¬â¡ï¸ğŸ›’ Transfer</button>
                </div>
              </div>
            </div>
          </section>

          <!-- RETAILER -->
          <section class="card page" id="page-retailer" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Retailer Panel</div>
                <div class="card-sub">Final teslim + inspection (sÃ¼reÃ§ burada biter).</div>
              </div>
              <div class="right">
                <span class="badge">Role: <span class="pillcode mono">RETAILER</span></span>
              </div>
            </div>
            <div class="card-body">
              <div class="section" style="margin-top:0;">
                <div class="section-head">
                  <div>
                    <div class="section-title">My Batches (Owned)</div>
                    <div class="muted small">Kontrat: getAllBatchIds() + getBatch() (currentOwner+stage filtre)</div>
                  </div>
                  <button class="btn" id="btnLoadAssignedRetailer">ğŸ“¥ Load</button>
                </div>
                <div class="list" id="rAssignedList"></div>
              </div>
              <div class="divider"></div>

              <div class="row">
                <div class="field" style="max-width:220px;">
                  <label>Batch ID</label>
                  <input id="rBatchId" placeholder="17" class="mono" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn good" id="btnPass">âœ” Passed</button>
                  <button class="btn bad" id="btnFail" style="margin-left:8px;">âœ– Failed</button>
                </div>
              </div>
              <div class="small muted" style="margin-top:10px;">markAsArrived(batchId, passedInspection)</div>
            </div>
          </section>

          <!-- ADMIN -->
          <section class="card page" id="page-admin" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Admin Panel</div>
                <div class="card-sub">Adreslere rol ver / rol kaldÄ±r (onlyOwner).</div>
              </div>
              <div class="right">
                <span class="badge">Role: <span class="pillcode mono">ADMIN</span></span>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="field">
                  <label>Address</label>
                  <input id="aAddr" placeholder="0x..." class="mono" />
                </div>
                <div class="field">
                  <label>Role</label>
                  <select id="aRole">
                    <option value="producer">Producer</option>
                    <option value="transporter">Transporter</option>
                    <option value="distributor">Distributor</option>
                    <option value="retailer">Retailer</option>
                  </select>
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn good" id="btnGrant">â• Grant</button>
                  <button class="btn bad" id="btnRevoke" style="margin-left:8px;">â– Revoke</button>
                </div>
              </div>
              <div class="small muted" style="margin-top:10px;">Not: Admin = contract owner() adresidir.</div>
            </div>
          </section>

          <!-- SETTINGS -->
          <section class="card page" id="page-settings" style="display:none;">
            <div class="card-head">
              <div>
                <div class="card-title">Settings</div>
                <div class="card-sub">Kontrat adresi sabit. AÄŸ deÄŸiÅŸtirdiÄŸinde doÄŸru networkâ€™te olduÄŸundan emin ol.</div>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="field">
                  <label>Contract Address</label>
                  <input id="sContract" class="mono" />
                </div>
                <div class="field" style="flex:0 0 auto; align-self:flex-end;">
                  <button class="btn" id="btnCopyContract">ğŸ“‹ Copy</button>
                </div>
              </div>
              <div class="small muted" style="margin-top:10px;">
                ABI bu sayfaya gÃ¶mÃ¼lÃ¼. Sadece bu adresi kullandÄ±ÄŸÄ± iÃ§in yanlÄ±ÅŸ kontrata baÄŸlanmaz.
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal-backdrop" id="pinModal">
    <div class="modal">
      <div class="modal-head">
        <div>
          <div class="modal-title">ğŸ” Admin PIN</div>
          <div class="small muted" id="pinHelp">Admin iÅŸlemleri iÃ§in PIN gir.</div>
        </div>
        <button class="btn" id="btnClosePin">âœ–</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="field">
            <label>PIN</label>
            <input id="pinInput" type="password" placeholder="4-8 haneli" class="mono" />
            <div class="small muted" id="pinHint">Ä°lk kez giriyorsan PIN kaydedilir (bu cihazda). Blockchain'e yazÄ±lmaz.</div>
          </div>
        </div>
        <div class="split" style="margin-top:12px;">
          <button class="btn primary" id="btnPinOk">Continue</button>
          <button class="btn" id="btnResetPin">Reset PIN</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toasts"></div>

<script>
/** ========= Contract Config ========= */
const CONTRACT_ADDRESS = "0x1fc8aBF77339CEee6D165a6F0aBcB6f043197BAe";

const ABI = [
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      }
    ],
    "name": "acceptPickup",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "internalType": "int256",
        "name": "temperature",
        "type": "int256"
      },
      {
        "internalType": "int256",
        "name": "humidity",
        "type": "int256"
      },
      {
        "internalType": "string",
        "name": "location",
        "type": "string"
      }
    ],
    "name": "addSensorData",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "retailer",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "passedInspection",
        "type": "bool"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "ArrivedAndInspected",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "producer",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "newTransporter",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "AssignedTransporterUpdated",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "producer",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "assignedTransporter",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "productName",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "quantityKg",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "BatchCreated",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "productName",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "quantityKg",
        "type": "uint256"
      }
    ],
    "name": "createBatch",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "productName",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "quantityKg",
        "type": "uint256"
      },
      {
        "internalType": "address",
        "name": "assignedTransporter",
        "type": "address"
      }
    ],
    "name": "createBatchAuto",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "newBatchId",
        "type": "uint256"
      }
    ],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "distributor",
        "type": "address"
      }
    ],
    "name": "DistributorRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "distributor",
        "type": "address"
      }
    ],
    "name": "DistributorRevoked",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "passedInspection",
        "type": "bool"
      }
    ],
    "name": "markAsArrived",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "from",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "OwnershipTransferred",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "PickupAccepted",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "producer",
        "type": "address"
      }
    ],
    "name": "ProducerRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "producer",
        "type": "address"
      }
    ],
    "name": "ProducerRevoked",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "distributor",
        "type": "address"
      }
    ],
    "name": "registerDistributor",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "producer",
        "type": "address"
      }
    ],
    "name": "registerProducer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "retailer",
        "type": "address"
      }
    ],
    "name": "registerRetailer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      }
    ],
    "name": "registerTransporter",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "retailer",
        "type": "address"
      }
    ],
    "name": "RetailerRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "retailer",
        "type": "address"
      }
    ],
    "name": "RetailerRevoked",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "distributor",
        "type": "address"
      }
    ],
    "name": "revokeDistributor",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "producer",
        "type": "address"
      }
    ],
    "name": "revokeProducer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "retailer",
        "type": "address"
      }
    ],
    "name": "revokeRetailer",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      }
    ],
    "name": "revokeTransporter",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "int256",
        "name": "temperature",
        "type": "int256"
      },
      {
        "indexed": false,
        "internalType": "int256",
        "name": "humidity",
        "type": "int256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "location",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "SensorLogged",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "internalType": "address",
        "name": "newOwner",
        "type": "address"
      }
    ],
    "name": "transferOwnership",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      }
    ],
    "name": "TransporterRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      }
    ],
    "name": "TransporterRevoked",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      },
      {
        "internalType": "address",
        "name": "newTransporter",
        "type": "address"
      }
    ],
    "name": "updateAssignedTransporter",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getAllBatchIds",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      }
    ],
    "name": "getBatch",
    "outputs": [
      {
        "components": [
          {
            "internalType": "uint256",
            "name": "batchId",
            "type": "uint256"
          },
          {
            "internalType": "string",
            "name": "productName",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "quantityKg",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "producer",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "assignedTransporter",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "currentOwner",
            "type": "address"
          },
          {
            "internalType": "enum FreshChain.Stage",
            "name": "stage",
            "type": "uint8"
          },
          {
            "internalType": "uint256",
            "name": "createdAt",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "lastUpdatedAt",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "arrived",
            "type": "bool"
          },
          {
            "internalType": "bool",
            "name": "passedInspection",
            "type": "bool"
          }
        ],
        "internalType": "struct FreshChain.Batch",
        "name": "",
        "type": "tuple"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "transporter",
        "type": "address"
      }
    ],
    "name": "getBatchesAssignedTo",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "ids",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      }
    ],
    "name": "getBatchHistory",
    "outputs": [
      {
        "components": [
          {
            "internalType": "uint256",
            "name": "batchId",
            "type": "uint256"
          },
          {
            "internalType": "string",
            "name": "productName",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "quantityKg",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "producer",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "assignedTransporter",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "currentOwner",
            "type": "address"
          },
          {
            "internalType": "enum FreshChain.Stage",
            "name": "stage",
            "type": "uint8"
          },
          {
            "internalType": "uint256",
            "name": "createdAt",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "lastUpdatedAt",
            "type": "uint256"
          },
          {
            "internalType": "bool",
            "name": "arrived",
            "type": "bool"
          },
          {
            "internalType": "bool",
            "name": "passedInspection",
            "type": "bool"
          }
        ],
        "internalType": "struct FreshChain.Batch",
        "name": "batch",
        "type": "tuple"
      },
      {
        "components": [
          {
            "internalType": "uint256",
            "name": "timestamp",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          }
        ],
        "internalType": "struct FreshChain.TransferRecord[]",
        "name": "transfers",
        "type": "tuple[]"
      },
      {
        "components": [
          {
            "internalType": "uint256",
            "name": "timestamp",
            "type": "uint256"
          },
          {
            "internalType": "int256",
            "name": "temperature",
            "type": "int256"
          },
          {
            "internalType": "int256",
            "name": "humidity",
            "type": "int256"
          },
          {
            "internalType": "string",
            "name": "location",
            "type": "string"
          },
          {
            "internalType": "address",
            "name": "recordedBy",
            "type": "address"
          }
        ],
        "internalType": "struct FreshChain.SensorData[]",
        "name": "sensors",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      }
    ],
    "name": "getSensorLogs",
    "outputs": [
      {
        "components": [
          {
            "internalType": "uint256",
            "name": "timestamp",
            "type": "uint256"
          },
          {
            "internalType": "int256",
            "name": "temperature",
            "type": "int256"
          },
          {
            "internalType": "int256",
            "name": "humidity",
            "type": "int256"
          },
          {
            "internalType": "string",
            "name": "location",
            "type": "string"
          },
          {
            "internalType": "address",
            "name": "recordedBy",
            "type": "address"
          }
        ],
        "internalType": "struct FreshChain.SensorData[]",
        "name": "",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "batchId",
        "type": "uint256"
      }
    ],
    "name": "getTransferLogs",
    "outputs": [
      {
        "components": [
          {
            "internalType": "uint256",
            "name": "timestamp",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "from",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "to",
            "type": "address"
          }
        ],
        "internalType": "struct FreshChain.TransferRecord[]",
        "name": "",
        "type": "tuple[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "isDistributor",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "isProducer",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "isRetailer",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "isTransporter",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "owner",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];
const CONTRACT_ABI = [{"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}], "name": "acceptPickup", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "int256", "name": "temperature", "type": "int256"}, {"internalType": "int256", "name": "humidity", "type": "int256"}, {"internalType": "string", "name": "location", "type": "string"}], "name": "addSensorData", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "stateMutability": "nonpayable", "type": "constructor"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "retailer", "type": "address"}, {"indexed": false, "internalType": "bool", "name": "passedInspection", "type": "bool"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "ArrivedAndInspected", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "producer", "type": "address"}, {"indexed": true, "internalType": "address", "name": "newTransporter", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "AssignedTransporterUpdated", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "producer", "type": "address"}, {"indexed": true, "internalType": "address", "name": "assignedTransporter", "type": "address"}, {"indexed": false, "internalType": "string", "name": "productName", "type": "string"}, {"indexed": false, "internalType": "uint256", "name": "quantityKg", "type": "uint256"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "BatchCreated", "type": "event"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "string", "name": "productName", "type": "string"}, {"internalType": "uint256", "name": "quantityKg", "type": "uint256"}], "name": "createBatch", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "string", "name": "productName", "type": "string"}, {"internalType": "uint256", "name": "quantityKg", "type": "uint256"}, {"internalType": "address", "name": "assignedTransporter", "type": "address"}], "name": "createBatchAuto", "outputs": [{"internalType": "uint256", "name": "newBatchId", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "distributor", "type": "address"}], "name": "DistributorRegistered", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "distributor", "type": "address"}], "name": "DistributorRevoked", "type": "event"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "bool", "name": "passedInspection", "type": "bool"}], "name": "markAsArrived", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "from", "type": "address"}, {"indexed": true, "internalType": "address", "name": "to", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "OwnershipTransferred", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "transporter", "type": "address"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "PickupAccepted", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "producer", "type": "address"}], "name": "ProducerRegistered", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "producer", "type": "address"}], "name": "ProducerRevoked", "type": "event"}, {"inputs": [{"internalType": "address", "name": "distributor", "type": "address"}], "name": "registerDistributor", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "producer", "type": "address"}], "name": "registerProducer", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "retailer", "type": "address"}], "name": "registerRetailer", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "transporter", "type": "address"}], "name": "registerTransporter", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "retailer", "type": "address"}], "name": "RetailerRegistered", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "retailer", "type": "address"}], "name": "RetailerRevoked", "type": "event"}, {"inputs": [{"internalType": "address", "name": "distributor", "type": "address"}], "name": "revokeDistributor", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "producer", "type": "address"}], "name": "revokeProducer", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "retailer", "type": "address"}], "name": "revokeRetailer", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [{"internalType": "address", "name": "transporter", "type": "address"}], "name": "revokeTransporter", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "uint256", "name": "batchId", "type": "uint256"}, {"indexed": true, "internalType": "address", "name": "transporter", "type": "address"}, {"indexed": false, "internalType": "int256", "name": "temperature", "type": "int256"}, {"indexed": false, "internalType": "int256", "name": "humidity", "type": "int256"}, {"indexed": false, "internalType": "string", "name": "location", "type": "string"}, {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}], "name": "SensorLogged", "type": "event"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "address", "name": "newOwner", "type": "address"}], "name": "transferOwnership", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "transporter", "type": "address"}], "name": "TransporterRegistered", "type": "event"}, {"anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "transporter", "type": "address"}], "name": "TransporterRevoked", "type": "event"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "address", "name": "newTransporter", "type": "address"}], "name": "updateAssignedTransporter", "outputs": [], "stateMutability": "nonpayable", "type": "function"}, {"inputs": [], "name": "getAllBatchIds", "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}], "name": "getBatch", "outputs": [{"components": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "string", "name": "productName", "type": "string"}, {"internalType": "uint256", "name": "quantityKg", "type": "uint256"}, {"internalType": "address", "name": "producer", "type": "address"}, {"internalType": "address", "name": "assignedTransporter", "type": "address"}, {"internalType": "address", "name": "currentOwner", "type": "address"}, {"internalType": "enum FreshChain.Stage", "name": "stage", "type": "uint8"}, {"internalType": "uint256", "name": "createdAt", "type": "uint256"}, {"internalType": "uint256", "name": "lastUpdatedAt", "type": "uint256"}, {"internalType": "bool", "name": "arrived", "type": "bool"}, {"internalType": "bool", "name": "passedInspection", "type": "bool"}], "internalType": "struct FreshChain.Batch", "name": "", "type": "tuple"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "transporter", "type": "address"}], "name": "getBatchesAssignedTo", "outputs": [{"internalType": "uint256[]", "name": "ids", "type": "uint256[]"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}], "name": "getBatchHistory", "outputs": [{"components": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}, {"internalType": "string", "name": "productName", "type": "string"}, {"internalType": "uint256", "name": "quantityKg", "type": "uint256"}, {"internalType": "address", "name": "producer", "type": "address"}, {"internalType": "address", "name": "assignedTransporter", "type": "address"}, {"internalType": "address", "name": "currentOwner", "type": "address"}, {"internalType": "enum FreshChain.Stage", "name": "stage", "type": "uint8"}, {"internalType": "uint256", "name": "createdAt", "type": "uint256"}, {"internalType": "uint256", "name": "lastUpdatedAt", "type": "uint256"}, {"internalType": "bool", "name": "arrived", "type": "bool"}, {"internalType": "bool", "name": "passedInspection", "type": "bool"}], "internalType": "struct FreshChain.Batch", "name": "batch", "type": "tuple"}, {"components": [{"internalType": "uint256", "name": "timestamp", "type": "uint256"}, {"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}], "internalType": "struct FreshChain.TransferRecord[]", "name": "transfers", "type": "tuple[]"}, {"components": [{"internalType": "uint256", "name": "timestamp", "type": "uint256"}, {"internalType": "int256", "name": "temperature", "type": "int256"}, {"internalType": "int256", "name": "humidity", "type": "int256"}, {"internalType": "string", "name": "location", "type": "string"}, {"internalType": "address", "name": "recordedBy", "type": "address"}], "internalType": "struct FreshChain.SensorData[]", "name": "sensors", "type": "tuple[]"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}], "name": "getSensorLogs", "outputs": [{"components": [{"internalType": "uint256", "name": "timestamp", "type": "uint256"}, {"internalType": "int256", "name": "temperature", "type": "int256"}, {"internalType": "int256", "name": "humidity", "type": "int256"}, {"internalType": "string", "name": "location", "type": "string"}, {"internalType": "address", "name": "recordedBy", "type": "address"}], "internalType": "struct FreshChain.SensorData[]", "name": "", "type": "tuple[]"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "uint256", "name": "batchId", "type": "uint256"}], "name": "getTransferLogs", "outputs": [{"components": [{"internalType": "uint256", "name": "timestamp", "type": "uint256"}, {"internalType": "address", "name": "from", "type": "address"}, {"internalType": "address", "name": "to", "type": "address"}], "internalType": "struct FreshChain.TransferRecord[]", "name": "", "type": "tuple[]"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "isDistributor", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "isProducer", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "isRetailer", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"}, {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "isTransporter", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"}, {"inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}];

/** ========= Global State ========= */
let provider = null;
let signer = null;
let contract = null;
let userAddress = null;
let chainId = null;

let roles = {
  admin:false,
  producer:false,
  transporter:false,
  distributor:false,
  retailer:false
};

const StageMap = {
  0: "NONE",
  1: "READY_FOR_PICKUP",
  2: "IN_TRANSIT",
  3: "AT_DISTRIBUTOR",
  4: "AT_RETAILER",
  5: "COMPLETED_PASS",
  6: "COMPLETED_FAIL"
};

/** ========= Stage Guards ========= */
const STAGE = {
  NONE: 0,
  READY_FOR_PICKUP: 1,
  IN_TRANSIT: 2,
  AT_DISTRIBUTOR: 3,
  AT_RETAILER: 4,
  COMPLETED_PASS: 5,
  COMPLETED_FAIL: 6
};

async function getBatchStage(batchId){
  if(!contract) return null;
  try{
    const b = await contract.getBatch(batchId);
    return Number(b.stage);
  }catch(e){
    return null;
  }
}

function setDisabled(id, disabled){
  const el = $(id);
  if(el) el.disabled = !!disabled;
}

async function refreshDistributorActionLocks(){
  if(!contract || typeof ethers==="undefined"){
    setDisabled("btnToRetailer", true);
    return;
  }
  const idStr = $("dBatchId")?.value?.trim();
  if(!idStr){ setDisabled("btnToRetailer", true); return; }
  const batchId = ethers.BigNumber.from(idStr);
  const stage = await getBatchStage(batchId);
  if(stage === null){ setDisabled("btnToRetailer", false); return; }
  const stageName = StageMap[stage] || String(stage);
  setDisabled("btnToRetailer", stageName !== "AT_DISTRIBUTOR");
}

async function refreshRetailerActionLocks(){
  if(!contract || typeof ethers==="undefined"){
    setDisabled("btnFinalize", true);
    return;
  }
  const idStr = $("rBatchId")?.value?.trim();
  if(!idStr){ setDisabled("btnFinalize", true); return; }
  const batchId = ethers.BigNumber.from(idStr);
  const stage = await getBatchStage(batchId);
  if(stage === null){ setDisabled("btnFinalize", false); return; }
  const stageName = StageMap[stage] || String(stage);
  setDisabled("btnFinalize", stageName !== "AT_RETAILER");
}

async function refreshTransporterActionLocks(){
  if(!contract || typeof ethers === "undefined") {
    setDisabled("btnAcceptPickup", true);
    setDisabled("btnAddSensor", true);
    setDisabled("btnToDistributor", true);
    return;
  }
  const idStr = $("tBatchId")?.value?.trim();
  if(!idStr){
    setDisabled("btnAcceptPickup", true);
    setDisabled("btnAddSensor", true);
    setDisabled("btnToDistributor", true);
    return;
  }
  const batchId = ethers.BigNumber.from(idStr);
  const stage = await getBatchStage(batchId);

  if(stage === null){
    // if cannot read, don't block UI (contract will still enforce)
    setDisabled("btnAcceptPickup", false);
    setDisabled("btnAddSensor", false);
    setDisabled("btnToDistributor", false);
    return;
  }

  const stageName = StageMap[stage] || String(stage);
  setDisabled("btnAcceptPickup", stageName !== "READY_FOR_PICKUP");
  setDisabled("btnAddSensor", stageName !== "IN_TRANSIT");
  setDisabled("btnToDistributor", stageName !== "IN_TRANSIT");
}

/** ========= UI Helpers ========= */
const $ = (id) => document.getElementById(id);
const on = (id, ev, fn) => { const el = $(id); if(el) el.addEventListener(ev, fn); };

function shortAddr(a){
  if(!a) return "â€”";
  return a.slice(0,6)+"â€¦"+a.slice(-4);
}

function fmtTime(ts){
  try {
    const d = new Date(Number(ts)*1000);
    return d.toLocaleString("tr-TR");
  } catch(e) {
    return String(ts);
  }
}

function toast(title, msg){
  const wrap = $("toasts");
  const el = document.createElement("div");
  el.className = "toast";
  el.innerHTML = `<div class="t1">${title}</div><div class="t2">${msg}</div>`;
  wrap.appendChild(el);
  setTimeout(()=> {
    el.style.opacity = "0";
    el.style.transform = "translateY(6px)";
    setTimeout(()=> el.remove(), 450);
  }, 4500);
}

function setActiveNav(page){
  document.querySelectorAll(".nav .item").forEach(i=>i.classList.remove("active"));
  const item = document.querySelector(`.nav .item[data-page="${page}"]`);
  if(item) item.classList.add("active");
}

function showPage(page){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  const el = $("page-"+page);
  if(el) el.style.display = "block";
  setActiveNav(page);
}

function roleDotClass(){
  $("roleDot").className = "role-dot";
  if(roles.admin) $("roleDot").classList.add("admin");
  else if(roles.producer) $("roleDot").classList.add("producer");
  else if(roles.transporter) $("roleDot").classList.add("transporter");
  else if(roles.distributor) $("roleDot").classList.add("distributor");
  else if(roles.retailer) $("roleDot").classList.add("retailer");
}

function roleLabel(){
  if(!userAddress) return "Public";
  if(roles.admin) return "Admin";
  const list = [];
  if(roles.producer) list.push("Producer");
  if(roles.transporter) list.push("Transporter");
  if(roles.distributor) list.push("Distributor");
  if(roles.retailer) list.push("Retailer");
  return list.length ? list.join(" + ") : "No Role";
}

function updateNavLocks(){
  document.querySelectorAll(".nav .item[data-need]").forEach(item=>{
    const need = item.getAttribute("data-need");
    let ok = false;
    if(need === "admin") ok = roles.admin;
    if(need === "producer") ok = roles.producer;
    if(need === "transporter") ok = roles.transporter;
    if(need === "distributor") ok = roles.distributor;
    if(need === "retailer") ok = roles.retailer;

    // Require PIN too
    const pinOk = isPinUnlocked();

    if(!userAddress || !pinOk || !ok) {
      item.classList.add("disabled");
    } else {
      item.classList.remove("disabled");
    }
  });
}

/** ========= PIN (local-only) ========= */
function pinKey(){
  if(!userAddress || !chainId) return null;
  return `freshchain_pin_${chainId}_${userAddress.toLowerCase()}`;
}
function hashPin(pin){
  // simple browser hash (not crypto-strong, but OK for UI gate)
  const s = "freshchain:"+pin;
  let h = 0;
  for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
  return String(h);
}
function isPinUnlocked(){
  const k = pinKey();
  if(!k) return false;
  return sessionStorage.getItem(k+"_unlocked") === "1";
}
function setPinUnlocked(v){
  const k = pinKey();
  if(!k) return;
  sessionStorage.setItem(k+"_unlocked", v ? "1" : "0");
  $("btnLock").style.display = userAddress ? "inline-flex" : "none";
  $("pinStatus").textContent = v ? "âœ… Unlocked" : "ğŸ”’ Locked";
}
function hasSavedPin(){
  const k = pinKey();
  if(!k) return false;
  return !!localStorage.getItem(k);
}
function savePin(pin){
  const k = pinKey();
  localStorage.setItem(k, hashPin(pin));
}
function verifyPin(pin){
  const k = pinKey();
  const stored = localStorage.getItem(k);
  if(!stored) return false;
  return stored === hashPin(pin);
}
function resetPin(){
  const k = pinKey();
  if(!k) return;
  localStorage.removeItem(k);
  sessionStorage.removeItem(k+"_unlocked");
}

/** ========= Wallet / Contract ========= */
async function connectWallet(){
  if (typeof ethers === "undefined") {
    toast("Ethers yÃ¼klenemedi", "CDN engellenmiÅŸ olabilir. SayfayÄ± yenile ve tekrar dene. EÄŸer hala olursa farklÄ± internet veya VPN dene.");
    return;
  }

  if(!window.ethereum) {
    toast("MetaMask yok", "LÃ¼tfen MetaMask kur ve tekrar dene.");
    return;
  }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();

  const net = await provider.getNetwork();
  chainId = net.chainId;

  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  $("addrPill").style.display = "inline-flex";
  $("addrShort").textContent = shortAddr(userAddress);
  $("btnConnect").textContent = "âœ… Connected";
  $("btnLock").style.display = "inline-flex";
  $("netName").textContent = `${net.name} (chainId=${net.chainId})`;
  $("contractShort").textContent = shortAddr(CONTRACT_ADDRESS);
  $("sContract").value = CONTRACT_ADDRESS;

  // PIN flow
  setPinUnlocked(false);
  openPinModal();

  await refreshRoles();
  await refreshFeed();
}

async function refreshRoles(){
  if(!contract || !userAddress) return;
  try {
    const owner = await contract.owner();
    roles.admin = owner.toLowerCase() === userAddress.toLowerCase();
    roles.producer = await contract.isProducer(userAddress);
    roles.transporter = await contract.isTransporter(userAddress);
    roles.distributor = await contract.isDistributor(userAddress);
    roles.retailer = await contract.isRetailer(userAddress);

    $("roleLabel").textContent = roleLabel();
    roleDotClass();
    updateNavLocks();
  } catch(e) {
    console.error(e);
    toast("Role okunamadÄ±", e?.message || String(e));
  }
}

function openPinModal(){
  $("pinModal").style.display = "grid";
  $("pinInput").value = "";
  if(hasSavedPin()) {
    $("pinHelp").textContent = "Admin iÅŸlemleri iÃ§in PIN gir.";
    $("pinHint").textContent = "Bu cihazda kayÄ±tlÄ± PIN ile doÄŸrulama yapÄ±lacak.";
    $("pinStatus").textContent = "ğŸ”’ Locked";
  } else {
    $("pinHelp").textContent = "Admin iÃ§in ilk giriÅŸ: PIN belirle (4-8 haneli).";
    $("pinHint").textContent = "PIN sadece bu cihazda saklanÄ±r (localStorage). Blockchain'e yazÄ±lmaz.";
    $("pinStatus").textContent = "ğŸ”“ Not set";
  }
}
function closePinModal(){
  $("pinModal").style.display = "none";
}
async function pinContinue(){
  const pin = $("pinInput").value.trim();
  if(pin.length < 4 || pin.length > 8) {
    toast("PIN", "PIN 4-8 haneli olmalÄ±.");
    return;
  }
  if(hasSavedPin()) {
    if(!verifyPin(pin)) {
      toast("PIN", "YanlÄ±ÅŸ PIN.");
      return;
    }
  } else {
    savePin(pin);
  }
  setPinUnlocked(true);
  closePinModal();
  updateNavLocks();
  toast("GiriÅŸ baÅŸarÄ±lÄ±", "MenÃ¼ler rolÃ¼ne gÃ¶re aÃ§Ä±ldÄ±.");
}

function lockNow(){
  setPinUnlocked(false);
  updateNavLocks();
  openPinModal();
}

function logoutNow(){
  userAddress = null;
  signer = null;
  contract = null;
  provider = null;
  roles = { admin:false, producer:false, transporter:false, distributor:false, retailer:false };

  $("addrPill").style.display = "none";
  $("btnConnect").textContent = "ğŸ”Œ Connect Wallet";
  $("btnLogout").style.display = "none";
  $("btnLock").style.display = "none";
  $("roleLabel").textContent = "Public";
  roleDotClass();
  $("pinStatus").textContent = "â€”";

  showPage("query");
  updateNavLocks();

  try{
    const k = pinKey();
    if(k) sessionStorage.removeItem(k+"_unlocked");
  }catch(_){}

  toast("Logged out", "Wallet baÄŸlantÄ±sÄ± kapatÄ±ldÄ±. Sayfa yenileniyor...");
  setTimeout(()=> location.reload(), 600);
}




/** ========= Incoming scan (debug) =========
 * If contract.getBatchesAssignedTo(addr) returns [], we can still show incoming loads by scanning all batches
 * and filtering currentOwner == userAddress.
 */
async function loadIncomingByOwner(listEl, onSelect, titleForEmpty){
  if(!listEl) return;
  listEl.innerHTML = "";
  const addr = String(userAddress||"").toLowerCase();
  console.log("[Incoming] start scan currentOwner==", addr);

  try{
    const ids = await contract.getAllBatchIds();
    console.log("[Incoming] getAllBatchIds =>", ids);
    let count = 0;

    for(let i=0;i<ids.length;i++){
      const id = ids[i];
      let b;
      try{
        b = await contract.getBatch(id);
      }catch(e){
        console.warn("[Incoming] getBatch failed for", id?.toString?.()||id, e);
        continue;
      }

      // Ethers tuple: supports both named and index access.
      const batchId = (b.batchId ?? b[0])?.toString?.() ?? String(b[0]);
      const productName = (b.productName ?? b[1]) ?? "";
      const quantityKg = (b.quantityKg ?? b[2])?.toString?.() ?? String(b[2]);
      const producer = (b.producer ?? b[3]) ?? "";
      const assignedTransporter = (b.assignedTransporter ?? b[4]) ?? "";
      const currentOwner = (b.currentOwner ?? b[5]) ?? "";
      const stageN = Number((b.stage ?? b[6])?.toString?.() ?? b[6]);

      if(i===0){
        console.log("[Incoming] sample batch keys:", Object.keys(b));
        console.log("[Incoming] sample batch tuple:", b);
      }

      const ownerAddr = String(currentOwner||"").toLowerCase();
      if(ownerAddr !== addr) continue;

      const stageName = StageMap[stageN] || String(stageN);
      const subtitle = `#${batchId} â€¢ ${productName} â€¢ ${quantityKg}kg â€¢ stage=${stageName} â€¢ producer=${shortAddr(producer)} â€¢ assignedT=${shortAddr(assignedTransporter)} â€¢ owner=${shortAddr(currentOwner)}`;
      const itemEl = renderTimelineItem("Incoming", subtitle, "Click to select");
      itemEl.style.cursor = "pointer";
      itemEl.addEventListener("click", ()=> onSelect({batchId, stageN}));
      listEl.appendChild(itemEl);
      count++;
    }

    console.log("[Incoming] matched count =", count);
    if(count===0){
      listEl.appendChild(renderTimelineItem("No incoming batches", titleForEmpty, ""));
      toast("Incoming", "0 match. Console'a bak: currentOwner vs wallet.");
    }else{
      toast("Incoming", count + " batch bulundu.");
    }
  }catch(e){
    console.error("[Incoming] fatal", e);
    listEl.appendChild(renderTimelineItem("Error", (e?.reason||e?.message||String(e)), ""));
  }
}

/** ========= Feed & Timeline ========= */
function iconForType(t){
  if(t==="BatchCreated") return "ğŸ§‘â€ğŸŒ¾";
  if(t==="PickupAccepted") return "âœ…";
  if(t==="SensorLogged") return "ğŸŒ¡ï¸";
  if(t==="OwnershipTransferred") return "ğŸ”";
  if(t==="ArrivedAndInspected") return "ğŸ›’";
  return "â€¢";
}

function renderTimelineItem(title, subtitle, right){
  const el = document.createElement("div");
  el.className = "t-item";
  el.innerHTML = `
    <div class="t-ic">${iconForType(title)}</div>
    <div class="t-main">
      <div class="t-top">
        <div>
          <div style="font-weight:850;">${title}</div>
          <div class="small muted" style="margin-top:3px;">${subtitle}</div>
        </div>
        <div class="small mono muted">${right || ""}</div>
      </div>
    </div>`;
  return el;
}

async function refreshFeed(){
  const feed = $("feed");
  feed.innerHTML = "";

  if(!provider) {
    feed.appendChild(renderTimelineItem("Connect Wallet", "Global feed iÃ§in wallet baÄŸla.", ""));
    $("feedRange").textContent = "â€”";
    return;
  }

  try {
    const iface = new ethers.utils.Interface(CONTRACT_ABI);
    const latest = await provider.getBlockNumber();
    // Home KPIs
    try{ $("homeKpiLastBlock").textContent = String(latest); }catch(_){}
    try{ $("homeKpiNet").textContent = $("netName")?.textContent || "â€”"; }catch(_){}
    const fromBlock = Math.max(0, latest - 50000); // adjust for your chain
    $("feedRange").textContent = `${fromBlock} â†’ ${latest}`;

    // Pull logs for key events
    const topics = [
      iface.getEventTopic("BatchCreated"),
      iface.getEventTopic("PickupAccepted"),
      iface.getEventTopic("SensorLogged"),
      iface.getEventTopic("OwnershipTransferred"),
      iface.getEventTopic("ArrivedAndInspected"),
    ];

    const logs = await provider.getLogs({
      address: CONTRACT_ADDRESS,
      fromBlock,
      toBlock: latest,
      topics: [topics] // OR on first topic
    });

    // Sort newest first
    logs.sort((a,b)=> (b.blockNumber - a.blockNumber) || (b.logIndex - a.logIndex));

    const take = logs.slice(0, 25);

    // Home KPIs (counts)
    try{
      if(contract){
        const ids = await contract.getAllBatchIds();
        $("homeKpiBatches").textContent = String(ids.length);
        let pass = 0;
        const limit = Math.min(ids.length, 80); // prevent heavy UI on big chains
        for(let i=0;i<limit;i++){
          const b = await contract.getBatch(ids[i]);
          if(Number(b.stage)===STAGE.COMPLETED_PASS) pass++;
        }
        $("homeKpiOnSale").textContent = (ids.length>80) ? (pass + "+") : String(pass);
      } else {
        $("homeKpiBatches").textContent = "â€”";
        $("homeKpiOnSale").textContent = "â€”";
      }
    }catch(_){}
    for(const lg of take){
      let parsed;
      try {
        parsed = iface.parseLog(lg);
      } catch(_) {
        continue;
      }
      const bn = lg.blockNumber;
      const event = parsed.name;
      const args = parsed.args;

      let subtitle = "";
      if(event==="BatchCreated"){
        subtitle = `Batch #${args.batchId} â€¢ ${args.productName} â€¢ ${args.quantityKg}kg â€¢ Producer ${shortAddr(args.producer)} â€¢ Assigned ${shortAddr(args.assignedTransporter)}`;
      } else if(event==="PickupAccepted"){
        subtitle = `Batch #${args.batchId} â€¢ Transporter ${shortAddr(args.transporter)}`;
      } else if(event==="SensorLogged"){
        subtitle = `Batch #${args.batchId} â€¢ ${args.temperature}Â°C â€¢ ${args.humidity}% â€¢ ${args.location} â€¢ ${shortAddr(args.transporter)}`;
      } else if(event==="OwnershipTransferred"){
        subtitle = `Batch #${args.batchId} â€¢ ${shortAddr(args.from)} â†’ ${shortAddr(args.to)}`;
      } else if(event==="ArrivedAndInspected"){
        subtitle = `Batch #${args.batchId} â€¢ Retailer ${shortAddr(args.retailer)} â€¢ Passed=${args.passedInspection}`;
      }

      feed.appendChild(renderTimelineItem(event, subtitle, `#${bn}`));
    }

    if(take.length === 0){
      feed.appendChild(renderTimelineItem("No events yet", "Bu kontratta henÃ¼z event yok.", ""));
    }
  } catch(e){
    console.error(e);
    feed.appendChild(renderTimelineItem("Feed error", e?.message || String(e), ""));
  }
}

async function queryBatch(){
  if(!provider || !contract) {
    toast("Wallet yok", "Ã–nce Connect Wallet.");
    return;
  }
  const idStr = $("qBatchId").value.trim();
  if(!idStr) return;
  const batchId = ethers.BigNumber.from(idStr);

  try {
    const res = await contract.getBatchHistory(batchId);
    const batch = res.batch;
    const transfers = res.transfers;
    const sensors = res.sensors;

    $("batchResult").style.display = "block";
    $("batchSummaryLine").textContent =
      `#${batch.batchId} â€¢ ${batch.productName} â€¢ Producer ${shortAddr(batch.producer)} â€¢ Assigned ${shortAddr(batch.assignedTransporter)} â€¢ Owner ${shortAddr(batch.currentOwner)}`;

    $("kpiKg").textContent = String(batch.quantityKg);
    $("stageText").textContent = StageMap[Number(batch.stage)] || String(batch.stage);
    $("inspText").textContent = batch.arrived ? (batch.passedInspection ? "PASSED" : "FAILED") : "â€”";

    // Sensor min/avg/max (UI computed)
    const temps = sensors.map(s => Number(s.temperature));
    const hums  = sensors.map(s => Number(s.humidity));
    const stat = (arr)=> {
      if(!arr.length) return null;
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
      return {min,max,avg};
    };
    const ts = stat(temps);
    const hs = stat(hums);

    $("kpiTemp").textContent = ts ? `${ts.min} / ${ts.avg.toFixed(1)} / ${ts.max}` : "â€”";
    $("kpiHum").textContent  = hs ? `${hs.min} / ${hs.avg.toFixed(1)} / ${hs.max}` : "â€”";
    $("kpiLogs").textContent = `${transfers.length} / ${sensors.length}`;

    // Timeline
    const tl = $("timeline");
    tl.innerHTML = "";

    tl.appendChild(renderTimelineItem(
      "BatchCreated",
      `Ãœretildi â€¢ ${batch.productName} â€¢ ${batch.quantityKg}kg â€¢ Producer ${shortAddr(batch.producer)} â€¢ Assigned ${shortAddr(batch.assignedTransporter)}`,
      fmtTime(batch.createdAt)
    ));

    for(const tr of transfers){
      tl.appendChild(renderTimelineItem(
        "OwnershipTransferred",
        `${shortAddr(tr.from)} â†’ ${shortAddr(tr.to)}`,
        fmtTime(tr.timestamp)
      ));
    }
    for(const s of sensors){
      tl.appendChild(renderTimelineItem(
        "SensorLogged",
        `${s.temperature}Â°C â€¢ ${s.humidity}% â€¢ ${s.location} â€¢ by ${shortAddr(s.recordedBy)}`,
        fmtTime(s.timestamp)
      ));
    }

    if(batch.arrived){
      tl.appendChild(renderTimelineItem(
        "ArrivedAndInspected",
        `Retailer kontrolÃ¼ â€¢ Passed=${batch.passedInspection}`,
        fmtTime(batch.lastUpdatedAt)
      ));
    }

  } catch(e) {
    console.error(e);
    toast("Query failed", e?.message || String(e));
  }
}

/** ========= Actions ========= */
async function ensureUnlockedAndRole(need){
  if(!userAddress) {
    toast("Wallet", "Ã–nce Connect Wallet.");
    return false;
  }
  if(!isPinUnlocked()) {
    toast("PIN", "Ã–nce PIN doÄŸrula.");
    openPinModal();
    return false;
  }
  if(need==="admin" && !roles.admin) return toast("Yetki", "Admin deÄŸilsin."), false;
  if(need==="producer" && !roles.producer) return toast("Yetki", "Producer deÄŸilsin."), false;
  if(need==="transporter" && !roles.transporter) return toast("Yetki", "Transporter deÄŸilsin."), false;
  if(need==="distributor" && !roles.distributor) return toast("Yetki", "Distributor deÄŸilsin."), false;
  if(need==="retailer" && !roles.retailer) return toast("Yetki", "Retailer deÄŸilsin."), false;
  return true;
}

async function txWrap(label, fn){
  try {
    const tx = await fn();
    toast(label, `Tx gÃ¶nderildi: ${tx.hash}`);
    await tx.wait();
    toast(label, "âœ… OnaylandÄ±");
    await refreshRoles();
    await refreshFeed();
    return true;
  } catch(e) {
    console.error(e);
    toast(label+" failed", e?.data?.message || e?.message || String(e));
    return false;
  }
}

async function producerCreate(){
  if(!await ensureUnlockedAndRole("producer")) return;
  const name = $("pName").value.trim();
  const kgStr = $("pKg").value.trim();
  const tr = $("pTransporter").value.trim();

  if(!name || !kgStr || !tr) return toast("Create Batch", "TÃ¼m alanlarÄ± doldur."), null;
  const kg = ethers.BigNumber.from(kgStr);

  $("pCreateOut").textContent = "Tx gÃ¶nderiliyor...";
  const ok = await txWrap("CreateBatchAuto", ()=> contract.createBatchAuto(name, kg, tr));
  $("pCreateOut").textContent = ok ? "âœ… OluÅŸturuldu (event/loglardan ID'yi gÃ¶rebilirsin)" : "âŒ Hata";
}

async function producerUpdateTransporter(){
  if(!await ensureUnlockedAndRole("producer")) return;
  const idStr = $("pUpBatchId").value.trim();
  const tr = $("pUpTransporter").value.trim();
  if(!idStr || !tr) return toast("Update", "BatchId + new transporter gir."), null;
  const batchId = ethers.BigNumber.from(idStr);
  await txWrap("UpdateAssignedTransporter", ()=> contract.updateAssignedTransporter(batchId, tr));
}

async function loadAssignedDistributor(){
  if(!await ensureUnlockedAndRole("distributor")) return;
  const list = $("dAssignedList"); if(!list) return;

  list.innerHTML = "";
  const addr = String(userAddress||"").toLowerCase();

  console.log("[DISTRIBUTOR][Owned] scan start owner==", addr, "stage=AT_DISTRIBUTOR(3)");

  let ids = [];
  try{
    ids = await contract.getAllBatchIds();
  }catch(e){
    console.error("[DISTRIBUTOR][Owned] getAllBatchIds failed", e);
    list.innerHTML = `<div class="small muted">Batch ID listesi alÄ±namadÄ±.</div>`;
    return;
  }

  let count = 0;
  for(const id of ids){
    let b;
    try{ b = await contract.getBatch(id); }catch(e){ console.warn("[DISTRIBUTOR][Owned] getBatch failed id=", id?.toString?.()||id, e); continue; }

    const batchId = Number((b.batchId ?? b[0]).toString());
    const productName = (b.productName ?? b[1]) || "â€”";
    const quantityKg = Number((b.quantityKg ?? b[2]).toString());
    const producer = (b.producer ?? b[3]) || "";
    const assignedTransporter = (b.assignedTransporter ?? b[4]) || "";
    const currentOwner = (b.currentOwner ?? b[5]) || "";
    const stageN = Number((b.stage ?? b[6]).toString());

    const ownerAddr = String(currentOwner||"").toLowerCase();
    if(ownerAddr !== addr) continue;
    if(stageN !== 3) continue; // AT_DISTRIBUTOR

    const stageName = StageMap[stageN] || String(stageN);
    const subtitle =
      `#${batchId} â€¢ ${productName} â€¢ ${quantityKg}kg â€¢ stage=${stageName} â€¢ producer=${shortAddr(producer)} â€¢ assignedT=${shortAddr(assignedTransporter)}`;

    const itemEl = renderTimelineItem("Owned", subtitle, "Click to select");
    itemEl.style.cursor = "pointer";
    itemEl.addEventListener("click", async ()=>{
      $("dBatchId").value = String(batchId);
      if($("dSelectedBadge")) $("dSelectedBadge").textContent = String(batchId);
      await refreshDistributorActionLocks();
      toast("Selected", "Batch #" + batchId + " seÃ§ildi.");
    });

    list.appendChild(itemEl);
    count++;
  }

  if(!count){
    list.innerHTML = `<div class="small muted">Bu cÃ¼zdana ait (owner) ve <b>AT_DISTRIBUTOR</b> aÅŸamasÄ±nda batch yok.</div>`;
  }else{
    console.log("[DISTRIBUTOR][Owned] found", count, "batches");
  }
}

async function loadAssignedRetailer(){
  if(!await ensureUnlockedAndRole("retailer")) return;
  const list = $("rAssignedList"); if(!list) return;

  list.innerHTML = "";
  const addr = String(userAddress||"").toLowerCase();

  console.log("[RETAILER][Owned] scan start owner==", addr, "stage=AT_RETAILER(4)");

  let ids = [];
  try{
    ids = await contract.getAllBatchIds();
  }catch(e){
    console.error("[RETAILER][Owned] getAllBatchIds failed", e);
    list.innerHTML = `<div class="small muted">Batch ID listesi alÄ±namadÄ±.</div>`;
    return;
  }

  let count = 0;
  for(const id of ids){
    let b;
    try{ b = await contract.getBatch(id); }catch(e){ console.warn("[RETAILER][Owned] getBatch failed id=", id?.toString?.()||id, e); continue; }

    const batchId = Number((b.batchId ?? b[0]).toString());
    const productName = (b.productName ?? b[1]) || "â€”";
    const quantityKg = Number((b.quantityKg ?? b[2]).toString());
    const producer = (b.producer ?? b[3]) || "";
    const assignedTransporter = (b.assignedTransporter ?? b[4]) || "";
    const currentOwner = (b.currentOwner ?? b[5]) || "";
    const stageN = Number((b.stage ?? b[6]).toString());

    const ownerAddr = String(currentOwner||"").toLowerCase();
    if(ownerAddr !== addr) continue;
    if(stageN !== 4) continue; // AT_RETAILER

    const stageName = StageMap[stageN] || String(stageN);
    const subtitle =
      `#${batchId} â€¢ ${productName} â€¢ ${quantityKg}kg â€¢ stage=${stageName} â€¢ producer=${shortAddr(producer)} â€¢ assignedT=${shortAddr(assignedTransporter)}`;

    const itemEl = renderTimelineItem("Owned", subtitle, "Click to select");
    itemEl.style.cursor = "pointer";
    itemEl.addEventListener("click", async ()=>{
      $("rBatchId").value = String(batchId);
      if($("rSelectedBadge")) $("rSelectedBadge").textContent = String(batchId);
      await refreshRetailerActionLocks();
      toast("Selected", "Batch #" + batchId + " seÃ§ildi.");
    });

    list.appendChild(itemEl);
    count++;
  }

  if(!count){
    list.innerHTML = `<div class="small muted">Bu cÃ¼zdana ait (owner) ve <b>AT_RETAILER</b> aÅŸamasÄ±nda batch yok.</div>`;
  }else{
    console.log("[RETAILER][Owned] found", count, "batches");
  }
}

async function loadAssigned(){
  if(!await ensureUnlockedAndRole("transporter")) return;
  const list = $("assignedList");
  list.innerHTML = "";
  try {
    const ids = await contract.getBatchesAssignedTo(userAddress);
    if(!ids.length){
      list.appendChild(renderTimelineItem("No assigned batches", "Åu an atanan batch yok.", ""));
      return;
    }
    for(const id of ids){
      const b = await contract.getBatch(id);
      const stage = StageMap[Number(b.stage)] || String(b.stage);
      const subtitle = `#${b.batchId} â€¢ ${b.productName} â€¢ ${b.quantityKg}kg â€¢ stage=${stage} â€¢ producer=${shortAddr(b.producer)}`;
      const itemEl = renderTimelineItem("Assigned", subtitle, "Click to select");
      itemEl.style.cursor = "pointer";
      itemEl.addEventListener("click", async ()=>{
        $("tBatchId").value = String(b.batchId);
        if($("tSelectedBadge")) $("tSelectedBadge").textContent = String(b.batchId);
        await refreshTransporterActionLocks();
        toast("Selected", "Batch #" + b.batchId + " seÃ§ildi.");
        const actionsTop = document.querySelector("#page-transporter");
        if(actionsTop) actionsTop.scrollIntoView({behavior:"smooth", block:"start"});
      });
      list.appendChild(itemEl);
    }
  } catch(e) {
    console.error(e);
    list.appendChild(renderTimelineItem("Load error", e?.message || String(e), ""));
  }
}

async function acceptPickup(){
  if(!await ensureUnlockedAndRole("transporter")) return;
  const idStr = $("tBatchId").value.trim();
  if(!idStr) return toast("Pickup", "BatchId gir."), null;
  const batchId = ethers.BigNumber.from(idStr);
  await txWrap("AcceptPickup", ()=> contract.acceptPickup(batchId));
  await refreshTransporterActionLocks();
}

async function addSensor(){
  if(!await ensureUnlockedAndRole("transporter")) return;
  const idStr = $("tBatchId").value.trim();
  const tempStr = $("tTemp").value.trim();
  const humStr = $("tHum").value.trim();
  const loc = $("tLoc").value.trim();
  if(!idStr || !tempStr || !humStr || !loc) return toast("Sensor", "BatchId + temp + hum + location gir."), null;
  const batchId = ethers.BigNumber.from(idStr);

  // UI rule: must accept pickup first
  const stage = await getBatchStage(batchId);
  const stageName = (stage === null) ? null : (StageMap[stage] || String(stage));
  if(stageName === "READY_FOR_PICKUP"){
    toast("Sensor", "Ã–nce âœ… Accept Pickup yapmalÄ±sÄ±n. (Stage: READY_FOR_PICKUP)");
    await refreshTransporterActionLocks();
    return;
  }
  if(stageName !== null && stageName !== "IN_TRANSIT"){
    toast("Sensor", "SensÃ¶r sadece taÅŸÄ±ma sÄ±rasÄ±nda eklenebilir. (Stage: " + stageName + ")");
    await refreshTransporterActionLocks();
    return;
  }

  const temp = ethers.BigNumber.from(tempStr);
  const hum  = ethers.BigNumber.from(humStr);
  await txWrap("AddSensorData", ()=> contract.addSensorData(batchId, temp, hum, loc));
}

async function toDistributor(){
  if(!await ensureUnlockedAndRole("transporter")) return;
  const idStr = $("tBatchId").value.trim();
  const dst = $("tDistributor").value.trim();
  if(!idStr || !dst) return toast("Transfer", "BatchId + distributor address gir."), null;
  const batchId = ethers.BigNumber.from(idStr);

  // UI rule: must accept pickup first
  const stage = await getBatchStage(batchId);
  const stageName = (stage === null) ? null : (StageMap[stage] || String(stage));
  if(stageName === "READY_FOR_PICKUP"){
    toast("Transfer", "Ã–nce âœ… Accept Pickup yapmalÄ±sÄ±n. (Stage: READY_FOR_PICKUP)");
    await refreshTransporterActionLocks();
    return;
  }
  if(stageName !== null && stageName !== "IN_TRANSIT"){
    toast("Transfer", "Transfer sadece taÅŸÄ±ma sÄ±rasÄ±nda yapÄ±labilir. (Stage: " + stageName + ")");
    await refreshTransporterActionLocks();
    return;
  }

  const ok = await txWrap("TransferOwnership", ()=> contract.transferOwnership(batchId, dst));
  if(ok){
    await refreshFeed();
    await loadAssigned(); // transporter list should shrink after transfer
  }
}

async function toRetailer(){
  if(!await ensureUnlockedAndRole("distributor")) return;
  const idStr = $("dBatchId").value.trim();
  const dst = $("dRetailer").value.trim();
  if(!idStr || !dst) return toast("Transfer", "BatchId + retailer address gir."), null;

  const batchId = ethers.BigNumber.from(idStr);
  const ok = await txWrap("TransferOwnership", ()=> contract.transferOwnership(batchId, dst));
  if(ok){
    await refreshFeed();
    await loadAssignedDistributor(); // distributor list should shrink after transfer
  }
}

async function retailerFinalize(passed){
  if(!await ensureUnlockedAndRole("retailer")) return;
  const idStr = $("rBatchId").value.trim();
  if(!idStr) return toast("Finalize", "BatchId gir."), null;
  const batchId = ethers.BigNumber.from(idStr);
  await txWrap("MarkAsArrived", ()=> contract.markAsArrived(batchId, passed));
}

async function adminGrantRevoke(isGrant){
  if(!await ensureUnlockedAndRole("admin")) return;
  const addr = $("aAddr").value.trim();
  const role = $("aRole").value;
  if(!addr) return toast("Admin", "Adres gir."), null;

  const map = {
    producer: isGrant ? "registerProducer" : "revokeProducer",
    transporter: isGrant ? "registerTransporter" : "revokeTransporter",
    distributor: isGrant ? "registerDistributor" : "revokeDistributor",
    retailer: isGrant ? "registerRetailer" : "revokeRetailer",
  };
  const fnName = map[role];
  await txWrap((isGrant?"Grant ":"Revoke ") + role, ()=> contract[fnName](addr));
}

/** ========= Event Live Updates (optional) ========= */
function startLiveListeners(){
  if(!provider || !contract) return;
  // If already attached, ethers doesn't easily tell; keep it simple.
  try {
    contract.on("BatchCreated", ()=> refreshFeed());
    contract.on("PickupAccepted", ()=> refreshFeed());
    contract.on("SensorLogged", ()=> refreshFeed());
    contract.on("OwnershipTransferred", ()=> refreshFeed());
    contract.on("ArrivedAndInspected", ()=> refreshFeed());
  } catch(e) {
    console.warn("Listener error", e);
  }
}

/** ========= Wire up UI ========= */
function init(){
  $("contractShort").textContent = shortAddr(CONTRACT_ADDRESS);
  $("sContract").value = CONTRACT_ADDRESS;

  // nav
  document.querySelectorAll(".nav .item").forEach(item => {
    item.addEventListener("click", () => {
      if(item.classList.contains("disabled")) {
        toast("Yetki", "Bu menÃ¼ iÃ§in rol + PIN gerekli.");
        return;
      }
      const page = item.getAttribute("data-page");
      showPage(page);
    });
  });

  $("btnConnect").addEventListener("click", async ()=> {
    await connectWallet();
    startLiveListeners();
  });
  on("btnLock", "click", lockNow);
  on("btnLogout", "click", logoutNow);

  on("btnQuery", "click", queryBatch);
  on("btnRefreshFeed", "click", refreshFeed);

  // PIN modal
  $("btnClosePin").addEventListener("click", ()=> {
    // keep locked if user closes
    closePinModal();
  });
  on("btnPinOk", "click", pinContinue);
  $("btnResetPin").addEventListener("click", ()=> {
    resetPin();
    toast("PIN reset", "Yeni PIN belirleyebilirsin.");
    openPinModal();
  });

  // Producer
  on("btnCreateBatch", "click", producerCreate);
  on("btnUpdateTransporter", "click", producerUpdateTransporter);

  // Transporter
  on("btnLoadAssigned", "click", loadAssigned);
on("btnLoadAssignedDistributor", "click", loadAssignedDistributor);
  on("btnLoadAssignedRetailer", "click", loadAssignedRetailer);
  on("btnAcceptPickup", "click", acceptPickup);
  on("btnAddSensor", "click", addSensor);
  on("btnToDistributor", "click", toDistributor);

  // Transporter: lock/unlock buttons based on stage
  $("tBatchId").addEventListener("input", ()=> { if($("tSelectedBadge")) $("tSelectedBadge").textContent = $("tBatchId").value.trim() || "â€”"; refreshTransporterActionLocks(); });
  $("tBatchId").addEventListener("change", ()=> { if($("tSelectedBadge")) $("tSelectedBadge").textContent = $("tBatchId").value.trim() || "â€”"; refreshTransporterActionLocks(); });


  // Distributor
  on("btnToRetailer", "click", toRetailer);
  $("dBatchId").addEventListener("input", ()=> { if($("dSelectedBadge")) $("dSelectedBadge").textContent = $("dBatchId").value.trim() || "â€”"; refreshDistributorActionLocks(); });
  $("dBatchId").addEventListener("change", ()=> { if($("dSelectedBadge")) $("dSelectedBadge").textContent = $("dBatchId").value.trim() || "â€”"; refreshDistributorActionLocks(); });

  // Retailer
  $("btnPass").addEventListener("click", ()=> retailerFinalize(true));
  $("btnFail").addEventListener("click", ()=> retailerFinalize(false));

  // Admin
  $("btnGrant").addEventListener("click", ()=> adminGrantRevoke(true));
  $("btnRevoke").addEventListener("click", ()=> adminGrantRevoke(false));

  // Settings
  $("btnCopyContract").addEventListener("click", async ()=> {
    await navigator.clipboard.writeText(CONTRACT_ADDRESS);
    toast("Copied", "Contract address kopyalandÄ±.");
  });

  // net pill initial
  $("netName").textContent = "â€”";

  // if metamask changes
  if(window.ethereum){
    window.ethereum.on("accountsChanged", async () => {
      location.reload();
    });
    window.ethereum.on("chainChanged", async () => {
      location.reload();
    });
  }

  // initial feed message
  refreshFeed();
  updateNavLocks();
}
init();

/** =========================
 *  PUBLIC QR (scan + generate)
 *  ========================= */
let __qr = { hq:null, running:false };

function parseBatchIdFromText(txt){
  if(!txt) return null;
  // allow formats like "FRESHCHAIN|...|123" or "BATCH:123" or just "123"
  const m = String(txt).match(/(\d{1,18})/g);
  if(!m || !m.length) return null;
  return m[m.length-1]; // last number
}

async function openPublicTraceWithId(idStr){
  if(!idStr) return;
  // go to home page
  try{
    showPage("query");
  }catch(_){
    // fallback: click nav item
    document.querySelectorAll(".nav .item").forEach(x=>x.classList.remove("active"));
    const it = document.querySelector('.nav .item[data-page="query"]');
    if(it) it.classList.add("active");
    const p = document.getElementById("page-query");
    if(p) p.style.display = "";
  }
  const inp = document.getElementById("qBatchId");
  if(inp) inp.value = idStr;
  const btn = document.getElementById("btnQuery");
  if(btn) btn.click();
}

async function startQR(){
  const wrap = $("qrReaderWrap");
  const stopBtn = $("btnStopQR");
  const startBtn = $("btnStartQR");
  if(!window.isSecureContext){ toast("QR","Kamera iÃ§in HTTPS veya localhost gerekir (file:// Ã§alÄ±ÅŸmaz)."); return; }
  if(!wrap || typeof Html5Qrcode === "undefined"){
    toast("QR", "QR kÃ¼tÃ¼phanesi yÃ¼klenemedi.");
    return;
  }
  wrap.style.display = "";
  startBtn.disabled = true;
  stopBtn.disabled = false;

  // reset old instance
  if(__qr.hq){
    try{ await __qr.hq.stop(); }catch(_){}
    try{ __qr.hq.clear(); }catch(_){}
    __qr.hq = null;
  }

  __qr.hq = new Html5Qrcode("qrReader");
  __qr.running = true;

  const onSuccess = async (decodedText)=>{
    const id = parseBatchIdFromText(decodedText);
    if(!id) return;
    $("qrLast").value = id;
    // auto stop after first success (less annoying)
    await stopQR();
    await openPublicTraceWithId(id);
  };

  const onFail = (_)=>{ /* silent */ };

  try{
    await __qr.hq.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 220 },
      onSuccess,
      onFail
    );
  }catch(e){
    startBtn.disabled = false;
    stopBtn.disabled = true;
    wrap.style.display = "none";
    toast("QR", (e && e.message) ? e.message : String(e));
  }
}

async function stopQR(){
  const wrap = $("qrReaderWrap");
  const stopBtn = $("btnStopQR");
  const startBtn = $("btnStartQR");
  stopBtn.disabled = true;
  startBtn.disabled = false;

  if(__qr.hq){
    try{ await __qr.hq.stop(); }catch(_){}
    try{ __qr.hq.clear(); }catch(_){}
    __qr.hq = null;
  }
  __qr.running = false;
  if(wrap) wrap.style.display = "none";
}

function bindQRTopBar(){
  $("btnStartQR")?.addEventListener("click", startQR);
  $("btnStopQR")?.addEventListener("click", stopQR);
  $("btnQRGo")?.addEventListener("click", ()=>{
    const id = parseBatchIdFromText($("qrManual")?.value);
    if(!id){ toast("Trace", "GeÃ§erli batchId gir."); return; }
    $("qrLast").value = id;
    openPublicTraceWithId(id);
  });
}

/** =========================
 *  MARKET (completed pass -> QR)
 *  ========================= */
async function loadMarket(){
  const list = $("marketList");
  const empty = $("marketEmpty");
  if(!list) return;

  list.innerHTML = "";
  if(empty) empty.style.display = "none";

  if(!contract){
    if(empty){ empty.textContent = "Ã–nce kontrata baÄŸlan (Settings)."; empty.style.display=""; }
    return;
  }

  let ids = [];
  try{ ids = await contract.getAllBatchIds(); }catch(e){
    if(empty){ empty.textContent = "getAllBatchIds okunamadÄ±."; empty.style.display=""; }
    return;
  }

  const q = ($("marketFilter")?.value || "").trim().toLowerCase();

  const items = [];
  for(const id of ids){
    try{
      const b = await contract.getBatch(id);
      const stage = Number(b.stage);
      if(stage !== STAGE.COMPLETED_PASS) continue; // satÄ±ÅŸa sadece PASS
      const name = (b.productName ?? b[1] ?? "").toString();
      if(q && !name.toLowerCase().includes(q)) continue;
      items.push({
        batchId: (b.batchId ?? b[0]).toString(),
        productName: name,
        quantityKg: (b.quantityKg ?? b[2]).toString(),
        producer: (b.producer ?? b[3]),
        updatedAt: Number(b.lastUpdatedAt ?? b[8] ?? 0)
      });
    }catch(_){}
  }

  if(!items.length){
    if(empty){ empty.textContent = "Åu an satÄ±ÅŸta Ã¼rÃ¼n yok (COMPLETED_PASS)."; empty.style.display=""; }
    return;
  }

  // newest first
  items.sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));

  for(const it of items){
    const wrap = document.createElement("div");
    wrap.className = "timeline-item";
    wrap.style.display = "flex";
    wrap.style.gap = "12px";
    wrap.style.alignItems = "center";

    const qrBox = document.createElement("div");
    qrBox.style.width = "96px";
    qrBox.style.height = "96px";
    qrBox.style.borderRadius = "12px";
    qrBox.style.background = "rgba(255,255,255,0.04)";
    qrBox.style.display = "flex";
    qrBox.style.alignItems = "center";
    qrBox.style.justifyContent = "center";
    qrBox.style.overflow = "hidden";

    const qrInner = document.createElement("div");
    qrBox.appendChild(qrInner);

    const meta = document.createElement("div");
    meta.style.flex = "1";

    const title = document.createElement("div");
    title.style.fontWeight = "700";
    title.textContent = `${it.productName}  â€¢  #${it.batchId}`;

    const sub = document.createElement("div");
    sub.className = "small muted";
    sub.textContent = `${it.quantityKg} kg â€¢ Producer: ${shortAddr(it.producer)} â€¢ Stage: COMPLETED_PASS`;

    const actions = document.createElement("div");
    actions.style.display = "flex";
    actions.style.gap = "8px";
    actions.style.flexWrap = "wrap";
    const btnView = document.createElement("button");
    btnView.className = "btn";
    btnView.textContent = "ğŸ” LoglarÄ± GÃ¶r";
    btnView.addEventListener("click", ()=> openPublicTraceWithId(it.batchId));

    actions.appendChild(btnView);

    meta.appendChild(title);
    meta.appendChild(sub);
    meta.appendChild(actions);

    wrap.appendChild(qrBox);
    wrap.appendChild(meta);
    list.appendChild(wrap);

    // generate QR after in DOM
    try{
      const payload = `FRESHCHAIN:BATCH:${it.batchId}`;
      new QRCode(qrInner, { text: payload, width: 92, height: 92, correctLevel: QRCode.CorrectLevel.M });
    }catch(_){
      qrInner.textContent = it.batchId;
    }
  }
}

function bindMarket(){
  $("btnRefreshMarket")?.addEventListener("click", loadMarket);
  $("marketFilter")?.addEventListener("input", ()=>{
    // light debounce
    clearTimeout(window.__mktT);
    window.__mktT = setTimeout(loadMarket, 250);
  });
}

// Hook into existing init once DOM ready
window.addEventListener("load", ()=>{
  bindQRTopBar();
  bindMarket();
});

// also refresh market after retailer finalize (if function exists)
const __oldFinalize = window.finalizeRetailer;

window.addEventListener("load", ()=>{
  const btn = $("btnFinalize");
  if(btn){
    btn.addEventListener("click", async ()=>{
      // after tx confirmed, your existing code likely already shows toast.
      // We'll just schedule market refresh a bit later; harmless.
      setTimeout(()=>{ try{ loadMarket(); }catch(_){} }, 2500);
    }, { capture:false });
  }
});

</script>
</body>
</html>